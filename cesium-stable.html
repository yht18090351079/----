<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CesiumJS ç¨³å®šç‰ˆ - åœ°è´¨ç¾å®³é¢„è­¦ç³»ç»Ÿ</title>
    
    <!-- å¼•å…¥CesiumJS CDN -->
    <script src="https://cesium.com/downloads/cesiumjs/releases/1.131/Build/Cesium/Cesium.js"></script>
    <link href="https://cesium.com/downloads/cesiumjs/releases/1.131/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
    
    <style>
        html, body, #cesiumContainer {
            width: 100%; height: 100%; margin: 0; padding: 0; overflow: hidden;
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: #000;
        }
        
        .info-panel {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 20px;
            border-radius: 8px;
            z-index: 1000;
            max-width: 350px;
            border: 1px solid #00D4FF;
            box-shadow: 0 0 20px rgba(0, 212, 255, 0.3);
        }
        
        .info-panel h3 {
            margin-top: 0;
            color: #00D4FF;
            font-size: 18px;
        }
        
        .info-item {
            margin: 8px 0;
            display: flex;
            justify-content: space-between;
        }
        
        .info-label {
            color: #B8C5D6;
        }
        
        .info-value {
            color: #00FF88;
            font-weight: bold;
        }
        
        .controls {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .btn {
            background: rgba(0, 0, 0, 0.8);
            color: #00D4FF;
            border: 1px solid #00D4FF;
            padding: 12px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            min-width: 150px;
            text-align: center;
        }
        
        .btn:hover {
            background: rgba(0, 212, 255, 0.2);
            box-shadow: 0 0 15px rgba(0, 212, 255, 0.5);
            transform: translateY(-2px);
        }
        
        .btn.active {
            background: rgba(0, 212, 255, 0.3);
            color: white;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .status-panel {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px;
            border-radius: 6px;
            z-index: 1000;
            border: 1px solid #2A3441;
        }
        
        .status-item {
            margin: 5px 0;
            font-size: 12px;
        }
        
        .status-online {
            color: #00FF88;
        }
        
        .status-offline {
            color: #FF4757;
        }
        
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            color: #00D4FF;
            font-size: 18px;
        }
        
        .loading-content {
            text-align: center;
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(0, 212, 255, 0.3);
            border-top: 3px solid #00D4FF;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div id="cesiumContainer"></div>
    
    <!-- åŠ è½½è¦†ç›–å±‚ -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <div>ğŸŒ æ­£åœ¨åˆå§‹åŒ–ç¨³å®šç‰ˆ3Dåœ°çƒ...</div>
            <div style="font-size: 14px; margin-top: 10px; color: #B8C5D6;">
                åŒ…å«è¡Œæ”¿åŒºåˆ’åŠŸèƒ½
            </div>
        </div>
    </div>
    
    <!-- ä¿¡æ¯é¢æ¿ -->
    <div class="info-panel">
        <h3>ğŸŒ åœ°è´¨ç¾å®³é¢„è­¦ç³»ç»Ÿ</h3>
        <div class="info-item">
            <span class="info-label">CesiumJSç‰ˆæœ¬:</span>
            <span class="info-value" id="cesiumVersion">1.131.0</span>
        </div>
        <div class="info-item">
            <span class="info-label">è¿è¡Œæ¨¡å¼:</span>
            <span class="info-value">ç¨³å®šç‰ˆ</span>
        </div>
        <div class="info-item">
            <span class="info-label">TokençŠ¶æ€:</span>
            <span class="info-value" id="tokenStatus">æ£€æµ‹ä¸­...</span>
        </div>
        <div class="info-item">
            <span class="info-label">åœ°å½¢ç±»å‹:</span>
            <span class="info-value" id="terrainType">æ¤­çƒä½“åœ°å½¢</span>
        </div>

        <div class="info-item">
            <span class="info-label">è¡Œæ”¿åŒºåˆ’:</span>
            <span class="info-value" id="boundaryStatus">å·²å…³é—­</span>
        </div>
        <div class="info-item">
            <span class="info-label">å½“å‰å½±åƒ:</span>
            <span class="info-value" id="imageryStatus">ä¸–ç•Œåœ°å½¢</span>
        </div>
        <div class="info-item">
            <span class="info-label">ç›‘æµ‹ç‚¹æ•°é‡:</span>
            <span class="info-value" id="pointCount">0</span>
        </div>
        <div class="info-item">
            <span class="info-label">å½“å‰ä½ç½®:</span>
            <span class="info-value">æˆéƒ½åœ°åŒº</span>
        </div>
    </div>
    
    <!-- æ§åˆ¶é¢æ¿ -->
    <div class="controls">
        <button class="btn" id="homeBtn">ğŸ  é£å›æˆéƒ½</button>
        <button class="btn" id="addPointBtn">ğŸ“ æ·»åŠ ç›‘æµ‹ç‚¹</button>
        <button class="btn" id="addAreaBtn">âš ï¸ æ·»åŠ é¢„è­¦åŒºåŸŸ</button>
        <button class="btn" id="terrainBtn">ğŸ”ï¸ åˆ‡æ¢åœ°å½¢</button>
        <button class="btn" id="boundaryBtn">ğŸ—¾ è¡Œæ”¿åŒºåˆ’</button>
        <button class="btn" id="imageryBtn">ğŸ—ºï¸ åˆ‡æ¢å½±åƒ</button>
        <button class="btn" id="clearBtn">ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰</button>
    </div>
    
    <!-- çŠ¶æ€é¢æ¿ -->
    <div class="status-panel">
        <div class="status-item">
            <span>ç³»ç»ŸçŠ¶æ€: </span>
            <span class="status-online" id="systemStatus">è¿è¡Œæ­£å¸¸</span>
        </div>
        <div class="status-item">
            <span>ç½‘ç»œçŠ¶æ€: </span>
            <span class="status-online">CDNåœ¨çº¿</span>
        </div>
        <div class="status-item">
            <span>IonæœåŠ¡: </span>
            <span class="status-online" id="ionStatus">è¿æ¥ä¸­...</span>
        </div>
        <div class="status-item">
            <span>å¿«æ·é”®: H(å›æˆéƒ½) P(ç›‘æµ‹ç‚¹) W(é¢„è­¦) T(åœ°å½¢) B(åŒºåˆ’) I(å½±åƒ)</span>
        </div>
    </div>

    <script>
        class StableCesiumApp {
            constructor() {
                this.viewer = null;
                this.pointCount = 0;
                this.terrainEnabled = true;  // é»˜è®¤å¼€å¯çœŸå®åœ°å½¢
                this.boundaryEnabled = false;
                this.imageryIndex = 0;
                this.boundaryDataSource = null;
                
                // æ‚¨çš„Cesium Ion Token
                this.token = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiI2YjZlZDZhMS0xZGMzLTRlMjAtOWMyMC1hY2U2ZGI1OWM3YzIiLCJpZCI6MzIyMjE3LCJpYXQiOjE3NTI3MTgyMDZ9.ESrgN3eQQTxnHv-UUG5aJz7ojlnK9EAzfqFqgXPmH7M';
                
                this.init();
            }
            
            async init() {
                try {
                    console.log('ğŸŒ å¼€å§‹åˆå§‹åŒ–ç¨³å®šç‰ˆCesiumJS...');
                    
                    // æ£€æŸ¥Cesiumæ˜¯å¦åŠ è½½
                    if (typeof Cesium === 'undefined') {
                        throw new Error('CesiumJS CDNåº“æœªåŠ è½½');
                    }
                    
                    // è®¾ç½®Cesium Ion Token
                    Cesium.Ion.defaultAccessToken = this.token;
                    document.getElementById('tokenStatus').textContent = 'å·²è®¾ç½®';
                    console.log('ğŸ”‘ Cesium Ion Tokenå·²è®¾ç½®');
                    
                    // åˆ›å»ºViewerï¼Œé»˜è®¤å¯ç”¨ä¸–ç•Œåœ°å½¢ä»¥æ”¯æŒåœ°å½¢å¤¸å¼ 
                    this.viewer = new Cesium.Viewer('cesiumContainer', {
                        homeButton: false,
                        sceneModePicker: false,
                        baseLayerPicker: false,
                        navigationHelpButton: false,
                        animation: false,
                        timeline: false,
                        fullscreenButton: false,
                        vrButton: false,
                        geocoder: false,
                        infoBox: true,
                        selectionIndicator: true
                        // ä¸è®¾ç½®terrainProviderï¼Œè®©Cesiumä½¿ç”¨é»˜è®¤çš„ä¸–ç•Œåœ°å½¢
                    });

                    // å°è¯•å¯ç”¨ä¸–ç•Œåœ°å½¢ä»¥æ”¯æŒåœ°å½¢å¤¸å¼ 
                    this.enableWorldTerrain();
                    
                    console.log('âœ… ç¨³å®šç‰ˆCesiumJS Vieweråˆ›å»ºæˆåŠŸ');
                    document.getElementById('ionStatus').textContent = 'å·²è¿æ¥';
                    
                    // é…ç½®åœºæ™¯
                    this.configureScene();
                    
                    // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
                    this.setupEventListeners();
                    
                    // é£è¡Œåˆ°æˆéƒ½
                    await this.flyToChengdu();
                    
                    // æ·»åŠ åˆå§‹å†…å®¹
                    this.addInitialContent();
                    
                    // éšè—åŠ è½½è¦†ç›–å±‚
                    this.hideLoading();
                    
                    console.log('ğŸ‰ ç¨³å®šç‰ˆCesiumJSåˆå§‹åŒ–å®Œæˆ');
                    
                } catch (error) {
                    console.error('âŒ ç¨³å®šç‰ˆCesiumJSåˆå§‹åŒ–å¤±è´¥:', error);
                    document.getElementById('ionStatus').textContent = 'è¿æ¥å¤±è´¥';
                    document.getElementById('ionStatus').className = 'status-offline';
                    this.showError(error.message);
                }
            }

            async enableWorldTerrain() {
                try {
                    // å°è¯•å¯ç”¨ä¸–ç•Œåœ°å½¢
                    if (typeof Cesium.createWorldTerrainAsync === 'function') {
                        this.viewer.terrainProvider = await Cesium.createWorldTerrainAsync({
                            requestWaterMask: true,
                            requestVertexNormals: true
                        });
                        this.terrainEnabled = true;
                        document.getElementById('terrainType').textContent = 'ä¸–ç•Œåœ°å½¢';
                        console.log('ğŸ”ï¸ ä¸–ç•Œåœ°å½¢å·²è‡ªåŠ¨å¯ç”¨ï¼Œæ”¯æŒåœ°å½¢å¤¸å¼ ');

                        this.setupTerrainSuccess();
                    } else if (typeof Cesium.createWorldTerrain === 'function') {
                        this.viewer.terrainProvider = Cesium.createWorldTerrain({
                            requestWaterMask: true,
                            requestVertexNormals: true
                        });
                        this.setupTerrainSuccess();
                    } else {
                        throw new Error('ä¸–ç•Œåœ°å½¢APIä¸å¯ç”¨');
                    }
                } catch (error) {
                    console.warn('ä¸–ç•Œåœ°å½¢å¯ç”¨å¤±è´¥ï¼Œä½¿ç”¨æ¤­çƒä½“åœ°å½¢:', error);
                    this.viewer.terrainProvider = new Cesium.EllipsoidTerrainProvider();
                    this.terrainEnabled = false;
                    document.getElementById('terrainType').textContent = 'æ¤­çƒä½“åœ°å½¢';

                    // æ¤­çƒä½“åœ°å½¢ä¸æ”¯æŒå¤¸å¼ ï¼Œç¦ç”¨å¤¸å¼ æŒ‰é’®
                    const exaggerationBtn = document.getElementById('exaggerationBtn');
                    if (exaggerationBtn) {
                        exaggerationBtn.disabled = true;
                        exaggerationBtn.textContent = 'â›°ï¸ éœ€è¦åœ°å½¢æ•°æ®';
                        exaggerationBtn.title = 'æ¤­çƒä½“åœ°å½¢ä¸æ”¯æŒå¤¸å¼ ï¼Œè¯·å…ˆå¯ç”¨ä¸–ç•Œåœ°å½¢';
                    }
                }
            }

            setupTerrainSuccess() {
                this.terrainEnabled = true;
                document.getElementById('terrainType').textContent = 'ä¸–ç•Œåœ°å½¢';
                console.log('ğŸ”ï¸ ä¸–ç•Œåœ°å½¢å·²è‡ªåŠ¨å¯ç”¨');
            }

            configureScene() {
                const scene = this.viewer.scene;

                // åŸºç¡€åœºæ™¯é…ç½®
                scene.globe.enableLighting = true;
                scene.fog.enabled = true;
                scene.fog.density = 0.0002;

                // å¯ç”¨æ·±åº¦æµ‹è¯•ï¼Œå¢å¼ºç«‹ä½“æ„Ÿ
                scene.globe.depthTestAgainstTerrain = true;

                // å¢å¼ºå…‰ç…§æ•ˆæœ
                scene.globe.dynamicAtmosphereLighting = true;
                scene.globe.dynamicAtmosphereLightingFromSun = true;

                // æ€§èƒ½ä¼˜åŒ–
                scene.globe.maximumScreenSpaceError = 2;
                scene.globe.tileCacheSize = 100;

                console.log('ğŸ¬ ç¨³å®šç‰ˆåœºæ™¯é…ç½®å®Œæˆ');
            }


            
            setupEventListeners() {
                // æŒ‰é’®äº‹ä»¶ç›‘å¬å™¨
                document.getElementById('homeBtn').addEventListener('click', () => this.flyToChengdu());
                document.getElementById('addPointBtn').addEventListener('click', () => this.addMonitoringPoint());
                document.getElementById('addAreaBtn').addEventListener('click', () => this.addWarningArea());
                document.getElementById('terrainBtn').addEventListener('click', (e) => this.toggleTerrain(e));
                document.getElementById('boundaryBtn').addEventListener('click', (e) => this.toggleBoundary(e));
                document.getElementById('imageryBtn').addEventListener('click', (e) => this.toggleImagery(e));
                document.getElementById('clearBtn').addEventListener('click', () => this.clearAll());
                
                // é”®ç›˜äº‹ä»¶ç›‘å¬å™¨
                document.addEventListener('keydown', (e) => this.handleKeyboard(e));
                
                console.log('âš¡ ç¨³å®šç‰ˆäº‹ä»¶ç›‘å¬å™¨å·²è®¾ç½®');
            }
            
            async flyToChengdu() {
                if (!this.viewer) return;
                
                return this.viewer.camera.flyTo({
                    destination: Cesium.Cartesian3.fromDegrees(104.0668, 30.5728, 50000),
                    orientation: {
                        heading: 0,
                        pitch: Cesium.Math.toRadians(-45),
                        roll: 0
                    },
                    duration: 2.0
                });
            }
            
            addInitialContent() {
                if (!this.viewer) return;
                
                // æ·»åŠ æˆéƒ½æ ‡è®°
                this.viewer.entities.add({
                    id: 'chengdu-city',
                    name: 'æˆéƒ½å¸‚',
                    position: Cesium.Cartesian3.fromDegrees(104.0668, 30.5728),
                    point: {
                        pixelSize: 25,
                        color: Cesium.Color.CYAN,
                        outlineColor: Cesium.Color.WHITE,
                        outlineWidth: 3
                    },
                    label: {
                        text: 'æˆéƒ½å¸‚',
                        font: '18pt sans-serif',
                        fillColor: Cesium.Color.WHITE,
                        outlineColor: Cesium.Color.BLACK,
                        outlineWidth: 2,
                        style: Cesium.LabelStyle.FILL_AND_OUTLINE,
                        pixelOffset: new Cesium.Cartesian2(0, -60)
                    }
                });
                
                // æ·»åŠ ä¸€äº›é¢„è®¾ç›‘æµ‹ç‚¹
                const presetPoints = [
                    { name: 'é¾™æ³‰å±±ç›‘æµ‹ç‚¹', lon: 104.2668, lat: 30.5728, status: 'normal' },
                    { name: 'é’åŸå±±ç›‘æµ‹ç‚¹', lon: 103.5668, lat: 30.8728, status: 'warning' },
                    { name: 'å³¨çœ‰å±±ç›‘æµ‹ç‚¹', lon: 103.4668, lat: 29.5728, status: 'danger' }
                ];
                
                presetPoints.forEach(point => {
                    this.addPointToMap(point.name, point.lon, point.lat, point.status);
                });
                
                console.log('ğŸ“ åˆå§‹å†…å®¹å·²æ·»åŠ ');
            }
            
            addMonitoringPoint() {
                const names = ['ç›‘æµ‹ç‚¹A', 'ç›‘æµ‹ç‚¹B', 'ç›‘æµ‹ç‚¹C', 'ç›‘æµ‹ç‚¹D', 'ç›‘æµ‹ç‚¹E'];
                const statuses = ['normal', 'warning', 'danger', 'normal'];
                
                const name = names[Math.floor(Math.random() * names.length)] + '-' + (this.pointCount + 1);
                const lon = 104.0668 + (Math.random() - 0.5) * 0.5;
                const lat = 30.5728 + (Math.random() - 0.5) * 0.5;
                const status = statuses[Math.floor(Math.random() * statuses.length)];
                
                this.addPointToMap(name, lon, lat, status);
            }
            
            addPointToMap(name, lon, lat, status) {
                const colors = {
                    normal: Cesium.Color.LIME,
                    warning: Cesium.Color.YELLOW,
                    danger: Cesium.Color.RED,
                    offline: Cesium.Color.GRAY
                };
                
                this.viewer.entities.add({
                    id: 'point-' + this.pointCount,
                    name: name,
                    position: Cesium.Cartesian3.fromDegrees(lon, lat, 100),
                    cylinder: {
                        length: 300,
                        topRadius: 80,
                        bottomRadius: 80,
                        material: colors[status].withAlpha(0.8),
                        outline: true,
                        outlineColor: colors[status]
                    },
                    label: {
                        text: name,
                        font: '12pt sans-serif',
                        fillColor: Cesium.Color.WHITE,
                        outlineColor: Cesium.Color.BLACK,
                        outlineWidth: 2,
                        style: Cesium.LabelStyle.FILL_AND_OUTLINE,
                        pixelOffset: new Cesium.Cartesian2(0, -150)
                    }
                });
                
                this.pointCount++;
                document.getElementById('pointCount').textContent = this.pointCount;
                console.log('ğŸ“ å·²æ·»åŠ ç›‘æµ‹ç‚¹:', name);
            }
            
            addWarningArea() {
                const areaId = 'warning-area-' + Date.now();
                const centerLon = 104.0668 + (Math.random() - 0.5) * 0.3;
                const centerLat = 30.5728 + (Math.random() - 0.5) * 0.3;
                const size = 0.05 + Math.random() * 0.05;
                
                this.viewer.entities.add({
                    id: areaId,
                    name: 'é¢„è­¦åŒºåŸŸ',
                    polygon: {
                        hierarchy: Cesium.Cartesian3.fromDegreesArray([
                            centerLon - size, centerLat - size,
                            centerLon + size, centerLat - size,
                            centerLon + size, centerLat + size,
                            centerLon - size, centerLat + size
                        ]),
                        height: 0,
                        extrudedHeight: 500,
                        material: Cesium.Color.RED.withAlpha(0.3),
                        outline: true,
                        outlineColor: Cesium.Color.RED
                    }
                });
                
                console.log('âš ï¸ å·²æ·»åŠ é¢„è­¦åŒºåŸŸ:', areaId);
            }
            
            async toggleTerrain(event) {
                if (!this.viewer) return;
                
                const btn = event.target;
                btn.disabled = true;
                
                try {
                    this.terrainEnabled = !this.terrainEnabled;
                    
                    if (this.terrainEnabled) {
                        // å°è¯•ä½¿ç”¨ä¸–ç•Œåœ°å½¢
                        try {
                            if (typeof Cesium.createWorldTerrainAsync === 'function') {
                                this.viewer.terrainProvider = await Cesium.createWorldTerrainAsync({
                                    requestWaterMask: true,
                                    requestVertexNormals: true
                                });
                            } else if (typeof Cesium.createWorldTerrain === 'function') {
                                this.viewer.terrainProvider = Cesium.createWorldTerrain({
                                    requestWaterMask: true,
                                    requestVertexNormals: true
                                });
                            } else {
                                throw new Error('ä¸–ç•Œåœ°å½¢APIä¸å¯ç”¨');
                            }
                            document.getElementById('terrainType').textContent = 'ä¸–ç•Œåœ°å½¢';
                            btn.textContent = 'ğŸ”ï¸ å…³é—­åœ°å½¢';

                            console.log('ğŸ”ï¸ ä¸–ç•Œåœ°å½¢å·²å¯ç”¨');
                        } catch (terrainError) {
                            console.warn('ä¸–ç•Œåœ°å½¢åŠ è½½å¤±è´¥ï¼Œä¿æŒæ¤­çƒä½“åœ°å½¢:', terrainError);
                            this.terrainEnabled = false;
                            btn.textContent = 'ğŸ”ï¸ å¼€å¯åœ°å½¢';
                        }
                    } else {
                        this.viewer.terrainProvider = new Cesium.EllipsoidTerrainProvider();
                        document.getElementById('terrainType').textContent = 'æ¤­çƒä½“åœ°å½¢';
                        btn.textContent = 'ğŸ”ï¸ å¼€å¯åœ°å½¢';

                        console.log('ğŸŒ æ¤­çƒä½“åœ°å½¢å·²å¯ç”¨');
                    }
                    
                    btn.classList.toggle('active', this.terrainEnabled);
                } catch (error) {
                    console.error('åœ°å½¢åˆ‡æ¢å¤±è´¥:', error);
                } finally {
                    btn.disabled = false;
                }
            }



            async toggleBoundary(event) {
                if (!this.viewer) return;

                const btn = event.target;
                btn.disabled = true;

                try {
                    this.boundaryEnabled = !this.boundaryEnabled;

                    if (this.boundaryEnabled) {
                        // å…ˆæ¸…é™¤ç°æœ‰çš„è¡Œæ”¿åŒºåˆ’æ•°æ®ï¼Œé¿å…é‡å¤
                        this.removeAdministrativeBoundaries();
                        await this.loadAdministrativeBoundaries();
                        document.getElementById('boundaryStatus').textContent = 'å·²å¼€å¯';
                        btn.textContent = 'ğŸ—¾ å…³é—­åŒºåˆ’';
                        console.log('ğŸ—¾ è¡Œæ”¿åŒºåˆ’å·²å¯ç”¨');
                    } else {
                        this.removeAdministrativeBoundaries();
                        document.getElementById('boundaryStatus').textContent = 'å·²å…³é—­';
                        btn.textContent = 'ğŸ—¾ è¡Œæ”¿åŒºåˆ’';
                        console.log('ğŸ—¾ è¡Œæ”¿åŒºåˆ’å·²å…³é—­');
                    }

                    btn.classList.toggle('active', this.boundaryEnabled);
                } catch (error) {
                    console.error('è¡Œæ”¿åŒºåˆ’åˆ‡æ¢å¤±è´¥:', error);
                    this.boundaryEnabled = false;
                    btn.textContent = 'ğŸ—¾ è¡Œæ”¿åŒºåˆ’';
                    document.getElementById('boundaryStatus').textContent = 'å·²å…³é—­';
                } finally {
                    btn.disabled = false;
                }
            }
            
            async loadAdministrativeBoundaries() {
                try {
                    // åˆ›å»ºè¡Œæ”¿åŒºåˆ’æ•°æ®æº
                    this.boundaryDataSource = new Cesium.CustomDataSource('è¡Œæ”¿åŒºåˆ’');
                    this.viewer.dataSources.add(this.boundaryDataSource);

                    // åŠ è½½çœŸå®çš„è¡Œæ”¿åŒºåˆ’æ•°æ®
                    await this.loadRealAdministrativeBoundaries();

                    console.log('ğŸ—¾ çœŸå®è¡Œæ”¿åŒºåˆ’æ•°æ®å·²åŠ è½½');
                } catch (error) {
                    console.error('åŠ è½½è¡Œæ”¿åŒºåˆ’å¤±è´¥:', error);
                    // å¦‚æœçœŸå®æ•°æ®åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨ç®€åŒ–æ•°æ®
                    this.loadSimplifiedBoundaries();
                    throw error;
                }
            }

            async loadRealAdministrativeBoundaries() {
                // å°è¯•åŠ è½½çœŸå®çš„ä¸­å›½è¡Œæ”¿åŒºåˆ’æ•°æ®
                try {
                    console.log('ğŸ—¾ å¼€å§‹åŠ è½½çœŸå®è¡Œæ”¿åŒºåˆ’æ•°æ®...');

                    // å°è¯•ä»åœ¨çº¿æ•°æ®æºåŠ è½½GeoJSON
                    await this.tryLoadOnlineGeoJSON();

                } catch (error) {
                    console.warn('åœ¨çº¿GeoJSONæ•°æ®åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨å†…ç½®çœŸå®åæ ‡:', error);

                    // ä½¿ç”¨å†…ç½®çš„çœŸå®åæ ‡æ•°æ®
                    await this.loadBuiltinRealBoundaries();
                }
            }

            async tryLoadOnlineGeoJSON() {
                // å°è¯•åŠ è½½åœ¨çº¿çš„ä¸­å›½è¡Œæ”¿åŒºåˆ’GeoJSONæ•°æ®
                const geoJsonUrls = [
                    // ä¸­å›½è¡Œæ”¿åŒºåˆ’GeoJSONæ•°æ®æº
                    'https://geo.datav.aliyun.com/areas_v3/bound/100000_full.json', // ä¸­å›½å…¨å¢ƒ
                    'https://geo.datav.aliyun.com/areas_v3/bound/510000_full.json', // å››å·çœ
                    'https://geo.datav.aliyun.com/areas_v3/bound/510100_full.json'  // æˆéƒ½å¸‚
                ];

                for (const url of geoJsonUrls) {
                    try {
                        console.log(`ğŸŒ å°è¯•åŠ è½½: ${url}`);
                        const dataSource = await Cesium.GeoJsonDataSource.load(url, {
                            stroke: Cesium.Color.CYAN,
                            strokeWidth: 2,
                            fill: Cesium.Color.CYAN.withAlpha(0.1)
                        });

                        this.viewer.dataSources.add(dataSource);
                        console.log(`âœ… æˆåŠŸåŠ è½½: ${url}`);

                    } catch (error) {
                        console.warn(`âŒ åŠ è½½å¤±è´¥: ${url}`, error);
                    }
                }
            }

            async loadBuiltinRealBoundaries() {
                // ä½¿ç”¨å†…ç½®çš„çœŸå®åæ ‡æ•°æ®
                console.log('ğŸ“ ä½¿ç”¨å†…ç½®çœŸå®åæ ‡æ•°æ®');

                // è®¾ç½®åœºæ™¯æ¸²æŸ“ä¼˜å…ˆçº§
                this.viewer.scene.globe.depthTestAgainstTerrain = false;

                // ä¸­å›½å›½ç•Œ
                await this.loadChinaBoundary();

                // çœçº§è¾¹ç•Œ
                await this.loadProvinceBoundaries();

                // å¸‚çº§è¾¹ç•Œï¼ˆé‡ç‚¹å…³æ³¨å››å·çœï¼‰
                await this.loadCityBoundaries();

                // å¿çº§è¾¹ç•Œï¼ˆé‡ç‚¹å…³æ³¨æˆéƒ½å¸‚ï¼‰
                await this.loadCountyBoundaries();

                // å¼ºåˆ¶æ¸²æŸ“
                this.viewer.scene.requestRender();
            }

            async loadChinaBoundary() {
                // ä¸­å›½çœŸå®å›½ç•Œè½®å»“ï¼ˆä¸»è¦è¾¹ç•Œç‚¹ï¼‰
                const chinaBoundary = [
                    // ä¸œåŒ—è¾¹ç•Œ
                    134.77, 48.27, 133.50, 47.05, 132.52, 47.78, 131.26, 46.64,
                    130.25, 47.75, 129.96, 48.73, 129.43, 49.44, 127.65, 49.76,
                    125.68, 50.39, 124.95, 52.93, 123.57, 53.56, 122.52, 53.37,
                    121.64, 53.30, 120.17, 52.75, 119.77, 52.25, 119.28, 50.78,
                    117.88, 49.51, 116.71, 49.88, 115.48, 49.38, 114.96, 50.14,
                    114.46, 50.25, 113.46, 49.99, 111.98, 49.54, 111.30, 48.99,
                    109.47, 49.09, 108.47, 49.28,

                    // è¥¿åŒ—è¾¹ç•Œ
                    107.86, 49.79, 106.89, 48.86, 106.01, 48.77, 105.08, 48.97,
                    103.31, 48.42, 101.83, 47.85, 100.84, 46.82, 99.98, 46.74,
                    98.50, 45.64, 97.17, 44.64, 95.94, 44.24, 94.68, 44.35,
                    93.51, 44.97, 92.23, 45.25, 90.94, 45.28, 90.28, 45.52,
                    88.80, 45.50, 87.36, 45.77, 86.82, 45.72, 85.54, 45.09,
                    84.54, 45.33, 83.18, 45.17, 82.20, 45.53, 81.20, 45.32,
                    80.26, 45.02, 79.28, 44.92, 78.18, 45.63, 76.77, 45.45,
                    75.62, 45.13, 74.21, 45.18, 73.50, 44.39,

                    // è¥¿å—è¾¹ç•Œ
                    73.50, 42.50, 74.98, 40.34, 75.15, 39.54, 73.96, 39.03,
                    73.67, 38.48, 74.22, 37.98, 74.98, 37.42, 74.83, 36.91,
                    75.31, 36.27, 75.72, 36.51, 76.19, 35.90, 77.82, 35.49,
                    78.73, 34.93, 78.40, 33.90, 79.21, 33.11, 79.21, 32.99,
                    78.17, 32.61, 78.73, 31.91, 79.72, 30.88, 81.11, 30.18,
                    80.48, 29.73, 80.09, 28.79, 81.06, 28.42, 82.32, 28.11,
                    83.89, 27.23, 85.02, 28.64, 86.50, 28.83, 87.75, 28.72,
                    88.81, 27.90, 88.73, 28.09, 89.74, 28.39, 90.37, 28.79,
                    91.31, 28.54, 92.50, 27.89, 93.48, 28.64, 94.56, 29.28,
                    95.40, 29.03, 96.12, 29.45, 97.05, 28.54, 97.79, 28.54,
                    98.67, 27.51, 98.73, 26.74, 98.67, 25.92, 97.72, 25.08,
                    97.73, 23.90, 98.67, 24.06, 98.83, 23.14, 99.12, 22.11,
                    99.98, 21.74, 101.15, 21.85, 101.20, 21.44,

                    // å—éƒ¨è¾¹ç•Œ
                    101.27, 21.20, 101.80, 21.17, 101.84, 21.49, 104.42, 22.81,
                    105.33, 23.35, 106.55, 22.21, 107.31, 21.61, 108.05, 21.55,
                    108.63, 21.42, 109.12, 21.97, 110.32, 21.39, 111.00, 21.94,
                    111.74, 21.95, 112.34, 21.47, 113.13, 22.11, 114.20, 22.22,
                    114.72, 22.73, 115.43, 22.50, 116.34, 21.55, 116.98, 21.54,
                    117.17, 23.46, 117.30, 23.62, 119.30, 25.31, 119.89, 25.73,
                    119.70, 26.92, 120.22, 27.05, 121.50, 25.05, 121.77, 24.40,
                    121.74, 22.79, 121.96, 22.31, 122.25, 22.56, 122.51, 23.56,
                    121.50, 25.05, 122.29, 29.58, 121.40, 31.19, 121.89, 31.69,
                    121.26, 32.46, 121.90, 33.37, 121.64, 34.86, 122.61, 37.39,
                    123.18, 37.89, 124.26, 39.93, 124.73, 40.50, 124.26, 39.93,
                    125.22, 40.87, 125.22, 42.65, 126.68, 42.02, 129.39, 42.99,
                    129.71, 44.77, 130.64, 44.86, 131.88, 45.32, 133.09, 45.14,
                    134.77, 48.27  // å›åˆ°èµ·ç‚¹
                ];

                // æ·»åŠ polygonå¡«å……
                this.boundaryDataSource.entities.add({
                    id: 'china-boundary-fill',
                    name: 'ä¸­åäººæ°‘å…±å’Œå›½å¡«å……',
                    polygon: {
                        hierarchy: Cesium.Cartesian3.fromDegreesArray(chinaBoundary),
                        material: Cesium.Color.RED.withAlpha(0.1),
                        outline: false,
                        height: 50000,
                        extrudedHeight: 80000,
                        heightReference: Cesium.HeightReference.RELATIVE_TO_GROUND
                    }
                });

                // æ·»åŠ polylineè¾¹ç•Œçº¿
                this.boundaryDataSource.entities.add({
                    id: 'china-boundary',
                    name: 'ä¸­åäººæ°‘å…±å’Œå›½',
                    polyline: {
                        positions: Cesium.Cartesian3.fromDegreesArray(chinaBoundary),
                        width: 10,
                        material: new Cesium.PolylineGlowMaterialProperty({
                            glowPower: 0.3,
                            color: Cesium.Color.RED
                        }),
                        clampToGround: false,
                        heightReference: Cesium.HeightReference.RELATIVE_TO_GROUND,
                        extrudedHeightReference: Cesium.HeightReference.RELATIVE_TO_GROUND,
                        zIndex: 1000
                    },
                    label: {
                        text: 'ä¸­åäººæ°‘å…±å’Œå›½',
                        font: '20pt sans-serif',
                        fillColor: Cesium.Color.RED,
                        outlineColor: Cesium.Color.WHITE,
                        outlineWidth: 3,
                        style: Cesium.LabelStyle.FILL_AND_OUTLINE,
                        pixelOffset: new Cesium.Cartesian2(0, -40),
                        show: true,
                        scale: 1.2
                    }
                });
            }

            async loadProvinceBoundaries() {
                // ä¸»è¦çœä»½è¾¹ç•Œæ•°æ®
                const provinces = [
                    {
                        name: 'å››å·çœ',
                        boundary: [
                            // å››å·çœçœŸå®è¾¹ç•Œåæ ‡
                            97.35, 32.99,  // è¥¿åŒ—è§’ï¼ˆç”˜å­œå·ï¼‰
                            99.17, 33.97,  // åŒ—éƒ¨ï¼ˆé˜¿åå·åŒ—ï¼‰
                            100.58, 33.30, // ä¸œåŒ—éƒ¨
                            102.72, 33.40, // ç”˜è‚ƒè¾¹ç•Œ
                            104.07, 33.30, // é™•è¥¿è¾¹ç•Œ
                            105.92, 32.85, // é‡åº†è¾¹ç•ŒåŒ—
                            107.89, 31.85, // é‡åº†è¾¹ç•Œä¸œ
                            108.54, 31.16, // é‡åº†è¾¹ç•Œä¸œå—
                            108.25, 30.05, // é‡åº†è¾¹ç•Œå—
                            107.89, 28.93, // è´µå·è¾¹ç•Œ
                            106.96, 28.23, // è´µå·è¾¹ç•Œè¥¿
                            105.97, 27.99, // äº‘å—è¾¹ç•Œ
                            104.52, 27.88, // äº‘å—è¾¹ç•Œ
                            103.04, 27.74, // äº‘å—è¾¹ç•Œè¥¿
                            101.89, 27.99, // äº‘å—è¾¹ç•Œè¥¿åŒ—
                            100.32, 28.29, // è¥¿è—è¾¹ç•Œ
                            99.15, 28.97,  // è¥¿è—è¾¹ç•Œ
                            98.47, 29.84,  // è¥¿è—è¾¹ç•Œ
                            97.91, 30.93,  // è¥¿è—è¾¹ç•Œ
                            97.35, 32.99   // å›åˆ°èµ·ç‚¹
                        ],
                        color: Cesium.Color.CYAN,
                        center: [104.0, 30.0]
                    },
                    {
                        name: 'é‡åº†å¸‚',
                        boundary: [
                            105.3, 31.5,
                            110.2, 31.5,
                            110.2, 28.2,
                            105.3, 28.2,
                            105.3, 31.5
                        ],
                        color: Cesium.Color.YELLOW,
                        center: [107.7, 29.8]
                    },
                    {
                        name: 'äº‘å—çœ',
                        boundary: [
                            97.5, 29.0,
                            106.0, 29.0,
                            106.0, 21.0,
                            97.5, 21.0,
                            97.5, 29.0
                        ],
                        color: Cesium.Color.GREEN,
                        center: [102.0, 25.0]
                    },
                    {
                        name: 'è´µå·çœ',
                        boundary: [
                            103.5, 29.2,
                            109.5, 29.2,
                            109.5, 24.5,
                            103.5, 24.5,
                            103.5, 29.2
                        ],
                        color: Cesium.Color.ORANGE,
                        center: [106.5, 26.8]
                    }
                ];

                provinces.forEach(province => {
                    // æ·»åŠ polygonå¡«å……
                    this.boundaryDataSource.entities.add({
                        id: `province-${province.name}-fill`,
                        name: `${province.name}å¡«å……`,
                        polygon: {
                            hierarchy: Cesium.Cartesian3.fromDegreesArray(province.boundary),
                            material: province.color.withAlpha(0.2),
                            outline: false,
                            height: 30000,
                            extrudedHeight: 60000,
                            heightReference: Cesium.HeightReference.RELATIVE_TO_GROUND
                        }
                    });

                    // æ·»åŠ polylineè¾¹ç•Œçº¿
                    this.boundaryDataSource.entities.add({
                        id: `province-${province.name}`,
                        name: province.name,
                        polyline: {
                            positions: Cesium.Cartesian3.fromDegreesArray(province.boundary),
                            width: 8,
                            material: new Cesium.PolylineGlowMaterialProperty({
                                glowPower: 0.2,
                                color: province.color
                            }),
                            clampToGround: false,
                            heightReference: Cesium.HeightReference.RELATIVE_TO_GROUND,
                            extrudedHeightReference: Cesium.HeightReference.RELATIVE_TO_GROUND,
                            zIndex: 900
                        },
                        label: {
                            text: province.name,
                            font: '18pt sans-serif',
                            fillColor: province.color,
                            outlineColor: Cesium.Color.BLACK,
                            outlineWidth: 3,
                            style: Cesium.LabelStyle.FILL_AND_OUTLINE,
                            pixelOffset: new Cesium.Cartesian2(0, -35),
                            show: true,
                            scale: 1.1
                        }
                    });
                });
            }

            async loadCityBoundaries() {
                // å››å·çœä¸»è¦åŸå¸‚è¾¹ç•Œ
                const cities = [
                    {
                        name: 'æˆéƒ½å¸‚',
                        boundary: [
                            // æˆéƒ½å¸‚çœŸå®è¾¹ç•Œåæ ‡
                            102.54, 31.42, // è¥¿åŒ—è§’ï¼ˆéƒ½æ±Ÿå °ï¼‰
                            103.17, 31.47, // åŒ—éƒ¨ï¼ˆå½­å·ï¼‰
                            104.33, 31.23, // ä¸œåŒ—è§’ï¼ˆé‡‘å ‚ï¼‰
                            104.70, 30.98, // ä¸œéƒ¨ï¼ˆç®€é˜³åŒ—ï¼‰
                            104.85, 30.39, // ä¸œå—è§’ï¼ˆç®€é˜³ï¼‰
                            104.37, 30.03, // å—éƒ¨ï¼ˆæ–°æ´¥ï¼‰
                            103.94, 29.97, // è¥¿å—è§’ï¼ˆé‚›å´ƒï¼‰
                            103.46, 30.41, // è¥¿éƒ¨ï¼ˆå¤§é‚‘ï¼‰
                            103.07, 30.63, // è¥¿éƒ¨ï¼ˆå´‡å·ï¼‰
                            102.54, 31.42  // å›åˆ°èµ·ç‚¹
                        ],
                        color: Cesium.Color.YELLOW,
                        center: [104.0, 30.7]
                    },
                    {
                        name: 'ç»µé˜³å¸‚',
                        boundary: [
                            104.0, 32.0,
                            105.5, 32.0,
                            105.5, 31.0,
                            104.0, 31.0,
                            104.0, 32.0
                        ],
                        color: Cesium.Color.LIME,
                        center: [104.7, 31.5]
                    },
                    {
                        name: 'å¾·é˜³å¸‚',
                        boundary: [
                            103.8, 31.5,
                            105.0, 31.5,
                            105.0, 30.8,
                            103.8, 30.8,
                            103.8, 31.5
                        ],
                        color: Cesium.Color.PINK,
                        center: [104.4, 31.1]
                    },
                    {
                        name: 'ä¹å±±å¸‚',
                        boundary: [
                            103.2, 29.8,
                            104.3, 29.8,
                            104.3, 29.0,
                            103.2, 29.0,
                            103.2, 29.8
                        ],
                        color: Cesium.Color.LIGHTBLUE,
                        center: [103.7, 29.4]
                    }
                ];

                cities.forEach(city => {
                    // æ·»åŠ polygonå¡«å……
                    this.boundaryDataSource.entities.add({
                        id: `city-${city.name}-fill`,
                        name: `${city.name}å¡«å……`,
                        polygon: {
                            hierarchy: Cesium.Cartesian3.fromDegreesArray(city.boundary),
                            material: city.color.withAlpha(0.3),
                            outline: false,
                            height: 20000,
                            extrudedHeight: 40000,
                            heightReference: Cesium.HeightReference.RELATIVE_TO_GROUND
                        }
                    });

                    // æ·»åŠ polylineè¾¹ç•Œçº¿
                    this.boundaryDataSource.entities.add({
                        id: `city-${city.name}`,
                        name: city.name,
                        polyline: {
                            positions: Cesium.Cartesian3.fromDegreesArray(city.boundary),
                            width: 6,
                            material: new Cesium.PolylineGlowMaterialProperty({
                                glowPower: 0.2,
                                color: city.color
                            }),
                            clampToGround: false,
                            heightReference: Cesium.HeightReference.RELATIVE_TO_GROUND,
                            extrudedHeightReference: Cesium.HeightReference.RELATIVE_TO_GROUND,
                            zIndex: 800
                        },
                        label: {
                            text: city.name,
                            font: '16pt sans-serif',
                            fillColor: city.color,
                            outlineColor: Cesium.Color.BLACK,
                            outlineWidth: 2,
                            style: Cesium.LabelStyle.FILL_AND_OUTLINE,
                            pixelOffset: new Cesium.Cartesian2(0, -30),
                            show: true,
                            scale: 1.0
                        }
                    });
                });
            }

            async loadCountyBoundaries() {
                // æˆéƒ½å¸‚ä¸»è¦åŒºå¿è¾¹ç•Œ
                const counties = [
                    {
                        name: 'é”¦æ±ŸåŒº',
                        boundary: [
                            // é”¦æ±ŸåŒºçœŸå®è¾¹ç•Œï¼ˆæˆéƒ½å¸‚ä¸­å¿ƒä¸œå—éƒ¨ï¼‰
                            104.081, 30.659, // è¥¿å—è§’
                            104.081, 30.695, // è¥¿åŒ—è§’
                            104.129, 30.695, // ä¸œåŒ—è§’
                            104.129, 30.659, // ä¸œå—è§’
                            104.081, 30.659  // å›åˆ°èµ·ç‚¹
                        ],
                        color: '#FFD700'  // é‡‘è‰²
                    },
                    {
                        name: 'é’ç¾ŠåŒº',
                        boundary: [
                            // é’ç¾ŠåŒºçœŸå®è¾¹ç•Œï¼ˆæˆéƒ½å¸‚ä¸­å¿ƒè¥¿éƒ¨ï¼‰
                            104.043, 30.659, // ä¸œå—è§’
                            104.043, 30.695, // ä¸œåŒ—è§’
                            104.081, 30.695, // è¥¿åŒ—è§’
                            104.081, 30.659, // è¥¿å—è§’
                            104.043, 30.659  // å›åˆ°èµ·ç‚¹
                        ],
                        color: '#C0C0C0'  // é“¶è‰²
                    },
                    {
                        name: 'é‡‘ç‰›åŒº',
                        boundary: [
                            // é‡‘ç‰›åŒºçœŸå®è¾¹ç•Œï¼ˆæˆéƒ½å¸‚ä¸­å¿ƒåŒ—éƒ¨ï¼‰
                            104.043, 30.695, // è¥¿å—è§’
                            104.043, 30.731, // è¥¿åŒ—è§’
                            104.129, 30.731, // ä¸œåŒ—è§’
                            104.129, 30.695, // ä¸œå—è§’
                            104.043, 30.695  // å›åˆ°èµ·ç‚¹
                        ],
                        color: '#CD7F32'  // é“œè‰²
                    },
                    {
                        name: 'æ­¦ä¾¯åŒº',
                        boundary: [
                            // æ­¦ä¾¯åŒºçœŸå®è¾¹ç•Œï¼ˆæˆéƒ½å¸‚ä¸­å¿ƒå—éƒ¨ï¼‰
                            104.043, 30.623, // è¥¿åŒ—è§’
                            104.043, 30.659, // ä¸œåŒ—è§’
                            104.129, 30.659, // ä¸œå—è§’
                            104.129, 30.623, // è¥¿å—è§’
                            104.043, 30.623  // å›åˆ°èµ·ç‚¹
                        ],
                        color: '#FF7F50'  // çŠç‘šè‰²
                    },
                    {
                        name: 'æˆååŒº',
                        boundary: [
                            // æˆååŒºçœŸå®è¾¹ç•Œï¼ˆæˆéƒ½å¸‚ä¸­å¿ƒä¸œåŒ—éƒ¨ï¼‰
                            104.129, 30.695, // è¥¿å—è§’
                            104.129, 30.731, // è¥¿åŒ—è§’
                            104.167, 30.731, // ä¸œåŒ—è§’
                            104.167, 30.695, // ä¸œå—è§’
                            104.129, 30.695  // å›åˆ°èµ·ç‚¹
                        ],
                        color: '#90EE90'  // æµ…ç»¿è‰²
                    },
                    {
                        name: 'é«˜æ–°åŒº',
                        boundary: [
                            // é«˜æ–°åŒºçœŸå®è¾¹ç•Œï¼ˆæˆéƒ½å¸‚è¥¿å—éƒ¨ï¼‰
                            103.995, 30.623, // è¥¿åŒ—è§’
                            103.995, 30.587, // è¥¿å—è§’
                            104.081, 30.587, // ä¸œå—è§’
                            104.081, 30.623, // ä¸œåŒ—è§’
                            103.995, 30.623  // å›åˆ°èµ·ç‚¹
                        ],
                        color: '#FF69B4'  // çƒ­ç²‰è‰²
                    },
                    {
                        name: 'å¤©åºœæ–°åŒº',
                        boundary: [
                            // å¤©åºœæ–°åŒºçœŸå®è¾¹ç•Œï¼ˆæˆéƒ½å¸‚å—éƒ¨ï¼‰
                            104.081, 30.587, // è¥¿åŒ—è§’
                            104.081, 30.515, // è¥¿å—è§’
                            104.205, 30.515, // ä¸œå—è§’
                            104.205, 30.587, // ä¸œåŒ—è§’
                            104.081, 30.587  // å›åˆ°èµ·ç‚¹
                        ],
                        color: '#00CED1'  // æ·±ç»¿å®çŸ³è‰²
                    }
                ];

                counties.forEach(county => {
                    // æ·»åŠ polygonå¡«å……
                    this.boundaryDataSource.entities.add({
                        id: `county-${county.name}-fill`,
                        name: `${county.name}å¡«å……`,
                        polygon: {
                            hierarchy: Cesium.Cartesian3.fromDegreesArray(county.boundary),
                            material: Cesium.Color.fromCssColorString(county.color).withAlpha(0.4),
                            outline: false,
                            height: 10000,
                            extrudedHeight: 20000,
                            heightReference: Cesium.HeightReference.RELATIVE_TO_GROUND
                        }
                    });

                    // æ·»åŠ polylineè¾¹ç•Œçº¿
                    this.boundaryDataSource.entities.add({
                        id: `county-${county.name}`,
                        name: county.name,
                        polyline: {
                            positions: Cesium.Cartesian3.fromDegreesArray(county.boundary),
                            width: 5,
                            material: new Cesium.PolylineGlowMaterialProperty({
                                glowPower: 0.2,
                                color: Cesium.Color.fromCssColorString(county.color)
                            }),
                            clampToGround: false,
                            heightReference: Cesium.HeightReference.RELATIVE_TO_GROUND,
                            extrudedHeightReference: Cesium.HeightReference.RELATIVE_TO_GROUND,
                            zIndex: 700
                        },
                        label: {
                            text: county.name,
                            font: '14pt sans-serif',
                            fillColor: Cesium.Color.fromCssColorString(county.color),
                            outlineColor: Cesium.Color.BLACK,
                            outlineWidth: 2,
                            style: Cesium.LabelStyle.FILL_AND_OUTLINE,
                            pixelOffset: new Cesium.Cartesian2(0, -25),
                            show: true,
                            scale: 0.9
                        }
                    });
                });
            }

            loadSimplifiedBoundaries() {
                // ç®€åŒ–ç‰ˆè¾¹ç•Œæ•°æ®ä½œä¸ºå¤‡ç”¨
                console.log('ğŸ—¾ åŠ è½½ç®€åŒ–ç‰ˆè¡Œæ”¿åŒºåˆ’æ•°æ®');
                this.addSichuanProvinceBoundary();
                this.addChengduCityBoundary();
                this.addMajorCities();
            }
            
            addSichuanProvinceBoundary() {
                // å››å·çœç®€åŒ–è¾¹ç•Œåæ ‡ï¼ˆç¤ºä¾‹ï¼‰
                const sichuanBoundary = [
                    97.5, 32.5,
                    108.5, 32.5,
                    108.5, 26.0,
                    97.5, 26.0
                ];
                
                this.boundaryDataSource.entities.add({
                    id: 'sichuan-province',
                    name: 'å››å·çœ',
                    polygon: {
                        hierarchy: Cesium.Cartesian3.fromDegreesArray(sichuanBoundary),
                        material: Cesium.Color.TRANSPARENT,
                        outline: true,
                        outlineColor: Cesium.Color.CYAN,
                        outlineWidth: 3,
                        height: 0
                    },
                    label: {
                        text: 'å››å·çœ',
                        font: '16pt sans-serif',
                        fillColor: Cesium.Color.CYAN,
                        outlineColor: Cesium.Color.BLACK,
                        outlineWidth: 2,
                        style: Cesium.LabelStyle.FILL_AND_OUTLINE,
                        pixelOffset: new Cesium.Cartesian2(0, -30),
                        show: true
                    }
                });
            }
            
            addChengduCityBoundary() {
                // æˆéƒ½å¸‚ç®€åŒ–è¾¹ç•Œåæ ‡ï¼ˆç¤ºä¾‹ï¼‰
                const chengduBoundary = [
                    103.5, 31.0,
                    104.8, 31.0,
                    104.8, 30.0,
                    103.5, 30.0
                ];
                
                this.boundaryDataSource.entities.add({
                    id: 'chengdu-city-boundary',
                    name: 'æˆéƒ½å¸‚è¡Œæ”¿åŒº',
                    polygon: {
                        hierarchy: Cesium.Cartesian3.fromDegreesArray(chengduBoundary),
                        material: Cesium.Color.YELLOW.withAlpha(0.1),
                        outline: true,
                        outlineColor: Cesium.Color.YELLOW,
                        outlineWidth: 2,
                        height: 0
                    }
                });
            }
            
            addMajorCities() {
                const cities = [
                    { name: 'ç»µé˜³å¸‚', lon: 104.7417, lat: 31.4640 },
                    { name: 'å¾·é˜³å¸‚', lon: 104.3984, lat: 31.1270 },
                    { name: 'ä¹å±±å¸‚', lon: 103.7614, lat: 29.5647 },
                    { name: 'çœ‰å±±å¸‚', lon: 103.8318, lat: 30.0756 },
                    { name: 'é›…å®‰å¸‚', lon: 103.0010, lat: 29.9877 }
                ];
                
                cities.forEach(city => {
                    this.boundaryDataSource.entities.add({
                        id: `city-${city.name}`,
                        name: city.name,
                        position: Cesium.Cartesian3.fromDegrees(city.lon, city.lat),
                        point: {
                            pixelSize: 12,
                            color: Cesium.Color.ORANGE,
                            outlineColor: Cesium.Color.WHITE,
                            outlineWidth: 2
                        },
                        label: {
                            text: city.name,
                            font: '12pt sans-serif',
                            fillColor: Cesium.Color.WHITE,
                            outlineColor: Cesium.Color.BLACK,
                            outlineWidth: 1,
                            style: Cesium.LabelStyle.FILL_AND_OUTLINE,
                            pixelOffset: new Cesium.Cartesian2(0, -30)
                        }
                    });
                });
            }
            
            removeAdministrativeBoundaries() {
                if (this.boundaryDataSource) {
                    this.viewer.dataSources.remove(this.boundaryDataSource);
                    this.boundaryDataSource = null;
                }
            }
            
            toggleImagery(event) {
                if (!this.viewer) return;

                const btn = event.target;
                btn.disabled = true;

                try {
                    // å½±åƒæä¾›è€…åˆ—è¡¨ - æä¾›çœŸæ­£ä¸åŒçš„å½±åƒç±»å‹
                    const imageryProviders = [
                        {
                            name: 'è¡—é“åœ°å›¾',
                            provider: () => new Cesium.OpenStreetMapImageryProvider({
                                url: 'https://tile.openstreetmap.org/',
                                fileExtension: 'png'
                            })
                        },
                        {
                            name: 'å«æ˜Ÿå½±åƒ',
                            provider: () => new Cesium.UrlTemplateImageryProvider({
                                url: 'https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}',
                                maximumLevel: 18,
                                credit: 'Google Earth'
                            })
                        },
                        {
                            name: 'åœ°å½¢å›¾',
                            provider: () => new Cesium.UrlTemplateImageryProvider({
                                url: 'https://mt1.google.com/vt/lyrs=p&x={x}&y={y}&z={z}',
                                maximumLevel: 18,
                                credit: 'Google Terrain'
                            })
                        }
                    ];

                    // ç¡®ä¿ç´¢å¼•æœ‰æ•ˆ
                    if (this.imageryIndex >= imageryProviders.length) {
                        this.imageryIndex = 0;
                    }

                    // å¾ªç¯åˆ‡æ¢å½±åƒ
                    this.imageryIndex = (this.imageryIndex + 1) % imageryProviders.length;
                    const currentImagery = imageryProviders[this.imageryIndex];

                    console.log(`ğŸ”„ åˆ‡æ¢åˆ°ç´¢å¼• ${this.imageryIndex}: ${currentImagery.name}`);

                    // ç§»é™¤å½“å‰å½±åƒå±‚
                    this.viewer.imageryLayers.removeAll();

                    // æ·»åŠ æ–°çš„å½±åƒå±‚
                    try {
                        const provider = currentImagery.provider();
                        const imageryLayer = new Cesium.ImageryLayer(provider);
                        this.viewer.imageryLayers.add(imageryLayer);

                        // æ›´æ–°æŒ‰é’®æ–‡æœ¬å’ŒçŠ¶æ€æ˜¾ç¤º
                        btn.textContent = `ğŸ—ºï¸ ${currentImagery.name}`;
                        document.getElementById('imageryStatus').textContent = currentImagery.name;

                        console.log('âœ… æˆåŠŸåˆ‡æ¢åˆ°:', currentImagery.name);

                    } catch (providerError) {
                        console.error(`âŒ å½±åƒæä¾›è€… ${currentImagery.name} åˆ›å»ºå¤±è´¥:`, providerError);

                        // ä½¿ç”¨æœ€åŸºæœ¬çš„OpenStreetMapä½œä¸ºå¤‡ç”¨
                        const fallbackProvider = new Cesium.OpenStreetMapImageryProvider({
                            url: 'https://a.tile.openstreetmap.org/'
                        });
                        this.viewer.imageryLayers.add(new Cesium.ImageryLayer(fallbackProvider));
                        btn.textContent = 'ğŸ—ºï¸ è¡—é“åœ°å›¾';
                        document.getElementById('imageryStatus').textContent = 'è¡—é“åœ°å›¾';
                        console.log('ï¿½ å·²é™çº§åˆ°åŸºç¡€è¡—é“åœ°å›¾');
                    }

                } catch (error) {
                    console.error('âŒ å½±åƒåˆ‡æ¢å¤±è´¥:', error);
                    btn.textContent = 'ğŸ—ºï¸ åˆ‡æ¢å½±åƒ';
                } finally {
                    btn.disabled = false;
                }
            }
            
            clearAll() {
                if (!this.viewer) return;
                
                // æ¸…é™¤æ‰€æœ‰å®ä½“ï¼ˆé™¤äº†æˆéƒ½æ ‡è®°ï¼‰
                const entities = this.viewer.entities.values;
                for (let i = entities.length - 1; i >= 0; i--) {
                    if (entities[i].id !== 'chengdu-city') {
                        this.viewer.entities.remove(entities[i]);
                    }
                }
                
                this.pointCount = 0;
                document.getElementById('pointCount').textContent = this.pointCount;
                
                console.log('ğŸ—‘ï¸ å·²æ¸…é™¤æ‰€æœ‰ç›‘æµ‹ç‚¹å’Œé¢„è­¦åŒºåŸŸ');
            }
            
            handleKeyboard(e) {
                switch (e.key.toLowerCase()) {
                    case 'h':
                        this.flyToChengdu();
                        break;
                    case 'p':
                        this.addMonitoringPoint();
                        break;
                    case 'w':
                        this.addWarningArea();
                        break;
                    case 't':
                        document.getElementById('terrainBtn').click();
                        break;
                    case 'b':
                        document.getElementById('boundaryBtn').click();
                        break;
                    case 'i':
                        document.getElementById('imageryBtn').click();
                        break;
                    case 'c':
                        this.clearAll();
                        break;
                }
            }
            
            hideLoading() {
                setTimeout(() => {
                    const overlay = document.getElementById('loadingOverlay');
                    if (overlay) {
                        overlay.style.opacity = '0';
                        setTimeout(() => {
                            overlay.style.display = 'none';
                        }, 500);
                    }
                }, 2000);
            }
            
            showError(message) {
                const overlay = document.getElementById('loadingOverlay');
                if (overlay) {
                    overlay.innerHTML = `
                        <div class="loading-content">
                            <div style="font-size: 48px; color: #FF4757; margin-bottom: 20px;">âŒ</div>
                            <div style="color: #FF4757;">åˆå§‹åŒ–å¤±è´¥</div>
                            <div style="font-size: 14px; margin-top: 10px; color: #B8C5D6;">
                                ${message}
                            </div>
                            <button onclick="location.reload()" style="margin-top: 20px; padding: 10px 20px; background: #00D4FF; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                é‡æ–°åŠ è½½
                            </button>
                        </div>
                    `;
                }
            }
        }
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.addEventListener('load', () => {
            window.stableCesiumApp = new StableCesiumApp();
        });
    </script>
</body>
</html>
